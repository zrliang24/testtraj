alpha = 0.5) +
scale_fill_viridis_c(option = 'plasma') +
labs(title = paste(region),
subtitle = paste('statistic:', statistic, '|',
'buffer:', buffer, '|',
'n =', nrow(trajAbr)))
if (justmap) {
print(outMap)
}
return(outMap)
}
# Make me many maps, and arrange them in a nice grid
make_more_maps <- function(regions, statistics, buffer = 10) {
maps <- c()
for (region in regions) {
for (statistic in statistics) {
# Generate map name
map_name <- paste0(region, '_', statistic, '_', buffer)
maps <- c(maps, map_name)
# use assign() to dynamically name each region and stat
assign(x = paste0(region, '_', statistic, '_', buffer),
value = make_cool_map(region, statistic, buffer, F),
envir = .GlobalEnv)
}
}
return(maps)
}
# Options: North, South, Downtown, Mare Island, Foothills
regions <- c('Downtown')
# Options: Ninetieth, Fiftieth, Tenth, Mean
statistics <- c('mean')
#
maps <- make_more_maps(regions, statistics, buffer = 20)
#
cowplot::plot_grid(plotlist = mget(maps),
nrow = 2,
ncol = 2)
traj <- map_dfr(dates, ~get_traj(.,
OutDir = '/home/donatello/Documents',
MetDir = '/home/donatello/Met',
ExecDir = '/home/donatello/Rprojects/testtraj/'))
ExecDir = '/home/donatello/Rprojects/testtraj/')
dates <- seq(as.Date('2019-02-01'),
as.Date('2019-02-25'),
"days") %>%
as.character()
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 & # ymin
lat <= 38.2 & # ymax
lon >= -122.38 & # xmin
lon <= -122.15)
# get extent
trajExt <- cbind(traj$lon, traj$lat) %>%
ext()
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.005,
crs = '+proj=longlat +datum=WGS84')
# create coordiates matrix for rasterize function
coords <- cbind(traj$lon, traj$lat)
# generate frequency plot
outputs <- rasterize(coords, trajgrid, fun = 'count')
plot(outputs)
# plot(outputs)
#
# save as dataframe for future use
saveRDS(as.data.frame(outputs, xy = T),
'/home/donatello/Rprojects/freqDF')
# read in saved dataframe
readRDS('/home/donatello/Rprojects/data/freqDF')
# read in saved dataframe
outputs <- readRDS('/home/donatello/Rprojects/data/freqDF')
# read in pm data, saved to an RDS already editted to keep the vignette clean
readRDS('/home/donatello/Rprojects/data/pmData')
# read in pm data, saved to an RDS already editted to keep the vignette clean
siteDF <- readRDS('/home/donatello/Rprojects/data/pmData')
make_cool_map <- function(region, statistic, buffer = 10, justmap = F) {
stats <- c('ninetieth',
'fiftieth',
'tenth',
'mean')
statFraction <- case_when(
statistic == stats[1] ~ 0.9,
statistic == stats[2] ~ 0.5,
statistic == stats[3] ~ 0.1,
statistic == stats[4] ~ 0,
T ~ NA)
# First, subset the PM data frame
abr <- subset(siteDF, Region == region)
if (is.na(statFraction)) {
print(paste('Please choose from',
paste(stats, collapse = ', ')))
return(NULL)
} else if (statFraction == 0) {
statDF <- abr %>%
mutate(Target = mean(PM),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
} else {
statDF <- abr %>%
mutate(Target = unname(quantile(PM, statFraction)),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
}
trajAbr <- subset(traj, trajTime %in% round(statDF$date, units = 'hours'))
# this is more straightforward and works too
if (nrow(trajAbr) > 100000) {
gritty <- rast(trajExt,
resolution = 0.001,
crs = '+proj=longlat +datum=WGS84')
} else {
gritty <- rast(trajExt,
resolution = 0.01,
crs = '+proj=longlat +datum=WGS84')
}
cff <- conditional_frequency_fraction(trajAbr,
coords,
gritty,
statDF,
remove.outliers = F)
outMap <- ggmap(vallejo) +
tidyterra::geom_spatraster(mapping = aes(),
data = cff,
alpha = 0.5) +
scale_fill_viridis_c(option = 'plasma') +
labs(title = paste(region),
subtitle = paste('statistic:', statistic, '|',
'buffer:', buffer, '|',
'n =', nrow(trajAbr)))
if (justmap) {
print(outMap)
}
return(outMap)
}
make_cool_map(region = 'Downtown', statistic = 'mean')
vallejo <- readRDS('/home/donatello/Rprojects/data/Vallejo_basemap.RDS')
make_cool_map(region = 'Downtown', statistic = 'mean')
make_cool_map(region = 'Downtown', statistic = 'mean')
usethis::use_r('make_map')
make_cool_map(region = 'Downtown', statistic = 'mean', just_map = F)
make_cool_map(region = 'Downtown', statistic = 'mean', justmap = F)
make_cool_map(region = 'Downtown', statistic = 'mean', justmap = T)
return(outMap)
# Create a function that creates the cff map from a given region and statistic
# Regions: North, South, Downtown, Foothills, Mare Island
make_cool_map <- function(region, statistic, buffer = 10, justmap = F) {
stats <- c('ninetieth',
'fiftieth',
'tenth',
'mean')
statFraction <- case_when(
statistic == stats[1] ~ 0.9,
statistic == stats[2] ~ 0.5,
statistic == stats[3] ~ 0.1,
statistic == stats[4] ~ 0,
T ~ NA)
# First, subset the PM data frame
abr <- subset(siteDF, Region == region)
if (is.na(statFraction)) {
print(paste('Please choose from',
paste(stats, collapse = ', ')))
return(NULL)
} else if (statFraction == 0) {
statDF <- abr %>%
mutate(Target = mean(PM),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
} else {
statDF <- abr %>%
mutate(Target = unname(quantile(PM, statFraction)),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
}
trajAbr <- subset(traj, trajTime %in% round(statDF$date, units = 'hours'))
# this is more straightforward and works too
if (nrow(trajAbr) > 100000) {
gritty <- rast(trajExt,
resolution = 0.001,
crs = '+proj=longlat +datum=WGS84')
} else {
gritty <- rast(trajExt,
resolution = 0.01,
crs = '+proj=longlat +datum=WGS84')
}
cff <- conditional_frequency_fraction(trajAbr,
coords,
gritty,
statDF,
remove.outliers = F)
outMap <- ggmap(vallejo) +
tidyterra::geom_spatraster(mapping = aes(),
data = cff,
alpha = 0.5) +
scale_fill_viridis_c(option = 'plasma') +
labs(title = paste(region),
subtitle = paste('statistic:', statistic, '|',
'buffer:', buffer, '|',
'n =', nrow(trajAbr)))
# if (justmap) {
#   print(outMap)
# }
return(outMap)
}
make_map <- function(region, statistic, buffer = 10, justmap = F) {
stats <- c('ninetieth',
'fiftieth',
'tenth',
'mean')
statFraction <- case_when(
statistic == stats[1] ~ 0.9,
statistic == stats[2] ~ 0.5,
statistic == stats[3] ~ 0.1,
statistic == stats[4] ~ 0,
T ~ NA)
# First, subset the PM data frame
abr <- subset(siteDF, Region == region)
if (is.na(statFraction)) {
print(paste('Please choose from',
paste(stats, collapse = ', ')))
return(NULL)
} else if (statFraction == 0) {
statDF <- abr %>%
mutate(Target = mean(PM),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
} else {
statDF <- abr %>%
mutate(Target = unname(quantile(PM, statFraction)),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
}
trajAbr <- subset(traj, trajTime %in% round(statDF$date, units = 'hours'))
# this is more straightforward and works too
if (nrow(trajAbr) > 100000) {
gritty <- rast(trajExt,
resolution = 0.001,
crs = '+proj=longlat +datum=WGS84')
} else {
gritty <- rast(trajExt,
resolution = 0.01,
crs = '+proj=longlat +datum=WGS84')
}
cff <- conditional_frequency_fraction(trajAbr,
coords,
gritty,
statDF,
remove.outliers = F)
outMap <- ggmap(vallejo) +
tidyterra::geom_spatraster(mapping = aes(),
data = cff,
alpha = 0.5) +
scale_fill_viridis_c(option = 'plasma') +
labs(title = paste(region),
subtitle = paste('statistic:', statistic, '|',
'buffer:', buffer, '|',
'n =', nrow(trajAbr)))
if (justmap) {
print(outMap)
}
return(outMap)
}
#'   Foothills, Mare Island
#' @param statistic Options are: Ninetieth, Fiftieth, Tenth, Mean
#' @param buffer Fraction out of 100 to exclude.
#' @param justmap
#'
#' @return
#' @export
#'
#' @examples
#'
make_map <- function(region, statistic, buffer = 10, justmap = F) {
stats <- c('ninetieth',
'fiftieth',
'tenth',
'mean')
statFraction <- case_when(
statistic == stats[1] ~ 0.9,
statistic == stats[2] ~ 0.5,
statistic == stats[3] ~ 0.1,
statistic == stats[4] ~ 0,
T ~ NA)
# First, subset the PM data frame
abr <- subset(siteDF, Region == region)
if (is.na(statFraction)) {
print(paste('Please choose from',
paste(stats, collapse = ', ')))
return(NULL)
} else if (statFraction == 0) {
statDF <- abr %>%
mutate(Target = mean(PM),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
} else {
statDF <- abr %>%
mutate(Target = unname(quantile(PM, statFraction)),
Upper = Target * (1 + buffer/100),
Lower = Target * (1 - buffer/100)) %>%
filter(between(PM, Lower, Upper)) %>%
ungroup()
}
trajAbr <- subset(traj, trajTime %in% round(statDF$date, units = 'hours'))
# this is more straightforward and works too
if (nrow(trajAbr) > 100000) {
gritty <- rast(trajExt,
resolution = 0.001,
crs = '+proj=longlat +datum=WGS84')
} else {
gritty <- rast(trajExt,
resolution = 0.01,
crs = '+proj=longlat +datum=WGS84')
}
cff <- conditional_frequency_fraction(trajAbr,
coords,
gritty,
statDF,
remove.outliers = F)
outMap <- ggmap(vallejo) +
tidyterra::geom_spatraster(mapping = aes(),
data = cff,
alpha = 0.5) +
scale_fill_viridis_c(option = 'plasma') +
labs(title = paste(region),
subtitle = paste('statistic:', statistic, '|',
'buffer:', buffer, '|',
'n =', nrow(trajAbr)))
# if (justmap) {
#   print(outMap)
# }
return(outMap)
}
check()
require(devtools)
check()
document()
gitcreds::gitcreds_set()
usethis::use_vignette('makemaps_vignette')
library(ggmap)
library(testtraj)
library(terra)
library(ggmap)
library(testtraj)
library(terra)
library(ggmap)
outputs <- readRDS('/home/donatello/Rprojects/data/freqDF')
siteDF <- readRDS('/home/donatello/Rprojects/data/pmData')
siteDF <- readRDS('/home/donatello/Rprojects/data/pmData')
document()
# Vallejo basemap
vallejo <- readRDS('/home/donatello/Rprojects/data/Vallejo_basemap.RDS')
library(testtraj)
load_all()
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = T)
rm(outputs)
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 & # ymin
lat <= 38.2 & # ymax
lon >= -122.38 & # xmin
lon <= -122.15)
make_cool_map(region = 'Downtown', statistic = 'mean', justmap = T)
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = T)
# get extent
trajExt <- cbind(traj$lon, traj$lat) %>%
ext()
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.005,
crs = '+proj=longlat +datum=WGS84')
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = T)
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 & # ymin
lat <= 38.2 & # ymax
lon >= -122.38 & # xmin
lon <= -122.15)
# get extent
trajExt <- cbind(traj$lon, traj$lat) %>%
ext()
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.005,
crs = '+proj=longlat +datum=WGS84')
# create coordiates matrix for rasterize function
coords <- cbind(traj$lon, traj$lat)
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = T)
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = T)
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10,
justmap = F)
check()
check()
load_all()
check()
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10)
check()
document()
check()
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10)
check()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(testtraj)
library(terra)
library(ggmap)
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 & # ymin
lat <= 38.2 & # ymax
lon >= -122.38 & # xmin
lon <= -122.15)
# get extent
trajExt <- cbind(traj$lon, traj$lat) %>%
ext()
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.005,
crs = '+proj=longlat +datum=WGS84')
# create coordiates matrix for rasterize function
coords <- cbind(traj$lon, traj$lat)
# Vallejo basemap
vallejo <- readRDS('/home/donatello/Rprojects/data/Vallejo_basemap.RDS')
# PM Data
siteDF <- readRDS('/home/donatello/Rprojects/data/pmData')
make_map(region = 'Downtown',
statistic = 'mean',
basemap = vallejo,
buffer = 10)
# library(testtraj)
# library(terra)
# read in trajectory data
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 &
lat <= 38.2 &
lon >= -122.38 &
lon <= -122.15)
library(testtraj)
library(terra)
# library(testtraj)
# library(terra)
# read in trajectory data
traj <- readRDS('/home/donatello/Rprojects/data/traj_example') %>%
# filter for points within Vallejo boundaries
filter(lat >= 38.0 &
lat <= 38.2 &
lon >= -122.38 &
lon <= -122.15)
# get extent
trajExt <- cbind(traj$lon, traj$lat) %>%
ext()
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.005,
crs = '+proj=longlat +datum=WGS84')
coords <- cbind(traj$lon, traj$lat)
# generate frequency plot
outputs <- rasterize(coords, trajgrid, fun = 'count')
plot(outputs)
# create blank grid from extent
trajgrid <- rast(trajExt,
resolution = 0.05,
crs = '+proj=longlat +datum=WGS84')
coords <- cbind(traj$lon, traj$lat)
# generate frequency plot
outputs <- rasterize(coords, trajgrid, fun = 'count')
plot(outputs)
